package com.example.test;

import android.Manifest;
import android.content.ContentResolver;
import android.content.ContentValues;
import android.content.Intent;
import android.content.SharedPreferences;
import android.content.pm.PackageManager;
import android.database.Cursor;
import android.database.sqlite.SQLiteDatabase;
import android.graphics.Bitmap;
import android.graphics.Color;
import android.net.Uri;
import android.os.Build;
import android.os.Bundle;
import android.os.Environment;
import android.os.Handler;
import android.os.Looper;
import android.provider.MediaStore;
import android.util.Log;
import android.util.Pair;
import android.view.MenuItem;
import android.view.View;
import android.widget.ImageView;
import android.widget.Toast;

import androidx.activity.result.ActivityResultLauncher;
import androidx.activity.result.contract.ActivityResultContracts;
import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import androidx.appcompat.app.AlertDialog;
import androidx.appcompat.app.AppCompatActivity;
import androidx.core.app.ActivityCompat;
import androidx.core.content.ContextCompat;

import com.google.android.material.appbar.MaterialToolbar;
import com.google.firebase.database.DataSnapshot;
import com.google.firebase.database.DatabaseReference;
import com.google.firebase.database.FirebaseDatabase;
import com.google.zxing.BarcodeFormat;
import com.google.zxing.WriterException;
import com.google.zxing.common.BitMatrix;
import com.google.zxing.qrcode.QRCodeWriter;

import org.apache.poi.ss.usermodel.Cell;
import org.apache.poi.ss.usermodel.CellType;
import org.apache.poi.ss.usermodel.DataFormatter;
import org.apache.poi.ss.usermodel.DateUtil;
import org.apache.poi.ss.usermodel.Row;
import org.apache.poi.ss.usermodel.Sheet;
import org.apache.poi.ss.usermodel.Workbook;
import org.apache.poi.ss.usermodel.WorkbookFactory;
import org.apache.poi.xssf.usermodel.XSSFWorkbook;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.TimeUnit;

public class AdminActivity extends AppCompatActivity {

    private static final int STORAGE_PERMISSION_CODE = 124;
    private static final String TAG = "AdminActivity";
    private com.google.firebase.database.ValueEventListener attendanceListener;


    private ImageView qrCodeImageView;
    private Uri attendanceFileUri;
    private MaterialToolbar toolbar;
    private final ExecutorService executor = Executors.newSingleThreadExecutor();
    private final Handler mainHandler = new Handler(Looper.getMainLooper());
    private DBHelper dbHelper;

    private final ActivityResultLauncher<Intent> pickFileLauncher = registerForActivityResult(
            new ActivityResultContracts.StartActivityForResult(),
            result -> {
                if (result.getResultCode() == RESULT_OK && result.getData() != null) {
                    Uri uri = result.getData().getData();
                    if (uri != null) {
                        try {
                            getContentResolver().takePersistableUriPermission(uri,
                                    Intent.FLAG_GRANT_READ_URI_PERMISSION | Intent.FLAG_GRANT_WRITE_URI_PERMISSION);
                            attendanceFileUri = uri;
                            Log.d(TAG, "Selected file Uri: " + attendanceFileUri.toString());
                            copyExcelFile(attendanceFileUri);

                            SharedPreferences prefs = getSharedPreferences("AppPrefs", MODE_PRIVATE);
                            SharedPreferences.Editor editor = prefs.edit();
                            editor.putString("attendance_file_uri", attendanceFileUri.toString());
                            editor.apply();

                            Toast.makeText(this, "ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÑŸÅ ÿ®ŸÜÿ¨ÿßÿ≠", Toast.LENGTH_SHORT).show();
                        } catch (SecurityException e) {
                            Log.e(TAG, "Permission error: " + e.getMessage());
                            showErrorAsync("ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ£ÿ∞ŸàŸÜÿßÿ™: " + e.getMessage());
                        }
                    } else {
                        showErrorAsync("ŸÖŸÅŸäÿ¥ ŸÖŸÑŸÅ ÿ™ŸÖ ÿßÿÆÿ™Ÿäÿßÿ±Ÿá ÿ£Ÿà ÿßŸÑŸÖŸÑŸÅ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠!");
                    }
                } else {
                    showErrorAsync("ŸÑŸÖ Ÿäÿ™ŸÖ ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÑŸÅ!");
                }
            });

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_admin);


        dbHelper = new DBHelper(this);
        initViews();
        setupToolbar();
        checkStoragePermission();

        SharedPreferences prefs = getSharedPreferences("AppPrefs", MODE_PRIVATE);
        String uriString = prefs.getString("attendance_file_uri", null);
        if (uriString != null) {
             attendanceFileUri = Uri.parse(uriString);
            Log.d(TAG, "Loaded attendance file Uri from preferences: " + attendanceFileUri.toString());
            if (!hasUriPermission(attendanceFileUri)) {
                attendanceFileUri = null;
                Toast.makeText(this, "ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÑŸÅ ÿßŸÑÿ≠ÿ∂Ÿàÿ± ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ", Toast.LENGTH_LONG).show();
            } else {
                // ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑŸÖŸÑŸÅ ŸÇÿßÿ®ŸÑ ŸÑŸÑŸÉÿ™ÿßÿ®ÿ©
                try (OutputStream testFos = getContentResolver().openOutputStream(attendanceFileUri)) {
                    if (testFos == null) {
                        attendanceFileUri = null;
                        Toast.makeText(this, "ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑŸÉÿ™ÿßÿ®ÿ© ÿ•ŸÑŸâ ÿßŸÑŸÖŸÑŸÅÿå ÿßÿÆÿ™ÿ± ŸÖŸÑŸÅŸãÿß ÿ¢ÿÆÿ±", Toast.LENGTH_LONG).show();
                    }
                } catch (Exception e) {
                    Log.e(TAG, "Cannot write to file: " + e.getMessage());
                    attendanceFileUri = null;
                    Toast.makeText(this, "ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑŸàÿµŸàŸÑ ŸÑŸÑŸÖŸÑŸÅÿå ÿßÿÆÿ™ÿ± ŸÖŸÑŸÅŸãÿß ÿ¢ÿÆÿ±", Toast.LENGTH_LONG).show();
                }
            }
        }
    }
    private void syncAttendanceFromFirebase(String sessionId, Uri excelUri, Runnable onComplete) {
        Log.d(TAG, "üîÅ [SYNC] ÿ®ÿØÿ° ŸÖÿ≤ÿßŸÖŸÜÿ© ÿßŸÑÿ≠ÿ∂Ÿàÿ± ŸÖŸÜ Firebase ŸÑŸÑÿ¨ŸÑÿ≥ÿ©: " + sessionId);

        DatabaseReference dbRef = FirebaseDatabase.getInstance()
                .getReference("attendance")
                .child(sessionId);

        dbRef.get().addOnSuccessListener(snapshot -> {
            if (snapshot.exists()) {
                Log.d(TAG, "üì• [SYNC] ÿπÿØÿØ ÿßŸÑÿ∑ŸÑÿßÿ® ŸÅŸä Firebase: " + snapshot.getChildrenCount());

                int[] counter = {0};
                long total = snapshot.getChildrenCount();

                for (DataSnapshot child : snapshot.getChildren()) {
                    String studentId = child.getKey();
                    String status = child.getValue(String.class);

                    Log.d(TAG, "üßæ [SYNC] ÿ∑ÿßŸÑÿ®: " + studentId + " | ÿßŸÑÿ≠ÿßŸÑÿ©: " + status);

                    if (status != null && status.contains("Present")) {
                        boolean updated = dbHelper.updateAttendance(studentId, AdminActivity.this, excelUri);
                        Log.d(TAG, "üõ†Ô∏è [SYNC] ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ∑ÿßŸÑÿ®ÿü " + updated);
                    }

                    counter[0]++;
                    if (counter[0] == total) {
                        Log.d(TAG, "‚úÖ [SYNC] ÿßŸÜÿ™Ÿáÿ™ ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ©");
                        onComplete.run();
                    }
                }
            } else {
                Log.w(TAG, "‚ö†Ô∏è [SYNC] ŸÑÿß ŸäŸàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä Firebase ŸÑŸÑÿ¨ŸÑÿ≥ÿ©");
                onComplete.run();
            }
        }).addOnFailureListener(e -> {
            Log.e(TAG, "‚ùå [SYNC] ŸÅÿ¥ŸÑ ŸÅŸä ÿ¨ŸÑÿ® ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ Firebase: " + e.getMessage(), e);
            onComplete.run();
        });
    }
    private boolean hasUriPermission(Uri uri) {
        try {
            getContentResolver().openInputStream(uri).close();
            return true;
        } catch (Exception e) {
            Log.e(TAG, "No permission to access Uri: " + e.getMessage());
            return false;
        }
    }

    public void onUpdateExcelClick(View view) {
        String sessionId = dbHelper.getLatestValidSessionId();
        if (sessionId == null) {
            showErrorAsync("‚ùå ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ¨ŸÑÿ≥ÿ© ÿ≠ÿßŸÑŸäÿ© ÿµÿßŸÑÿ≠ÿ©!");
            return;
        }

        Toast.makeText(this, "‚è≥ ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ≠ÿ∂Ÿàÿ± ŸÖŸÜ Firebase Ÿàÿ•ŸÜÿ¥ÿßÿ° ŸÖŸÑŸÅ ÿ¨ÿØŸäÿØ...", Toast.LENGTH_SHORT).show();
        generateExcelFromFirebase(sessionId);
    }

    private void reloadExcelFileAsync() {
        executor.execute(() -> {
            try {
                String result = readExcelData(attendanceFileUri);
                mainHandler.post(() -> {
                    if (result != null) {
                        Intent intent = new Intent(AdminActivity.this, DisplayActivity.class);
                        intent.putExtra("excel_data", result);
                        startActivity(intent);
                    } else {
                        showErrorAsync("ŸÅÿ¥ŸÑ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ•ŸÉÿ≥ŸÑ!");
                    }
                });
            } catch (Exception e) {
                Log.e(TAG, "Error reloading Excel: " + e.getMessage(), e);
                showErrorAsync("ÿÆÿ∑ÿ£: " + e.getMessage());
            }
        });
    }

    private String readExcelData(Uri fileUri) {
        StringBuilder result = new StringBuilder();
        try (InputStream fis = getContentResolver().openInputStream(fileUri);
             Workbook workbook = WorkbookFactory.create(fis)) {
            Sheet sheet = workbook.getSheetAt(0);
            if (sheet == null) {
                Log.e(TAG, "No data in Excel sheet!");
                return null;
            }
            for (Row row : sheet) {
                if (row.getRowNum() == 0) continue;
                Cell idCell = row.getCell(0, Row.MissingCellPolicy.CREATE_NULL_AS_BLANK);
                Cell nameCell = row.getCell(1, Row.MissingCellPolicy.CREATE_NULL_AS_BLANK);
                Cell attendanceCell = row.getCell(2, Row.MissingCellPolicy.CREATE_NULL_AS_BLANK);
                String studentId = idCell.toString().trim();
                String studentName = nameCell.toString().trim();
                String attendanceStatus = attendanceCell.toString().trim();
                result.append(studentId).append(" - ").append(studentName).append(": ").append(attendanceStatus).append("\n\n");
            }
            Log.d(TAG, "Excel data loaded successfully!");
            return result.toString();
        } catch (Exception e) {
            Log.e(TAG, "Error reading Excel: " + e.getMessage(), e);
            return null;
        }
    }
    private void initViews() {
        qrCodeImageView = findViewById(R.id.qrCodeImageView);
        toolbar = findViewById(R.id.toolbar);
    }

    private void setupToolbar() {
        setSupportActionBar(toolbar);
        if (getSupportActionBar() != null) {
            getSupportActionBar().setDisplayHomeAsUpEnabled(true);
            getSupportActionBar().setTitle("Admin Dashboard");
        }
    }

    private void checkStoragePermission() {
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.Q) {
            // ŸÑÿß ÿ≠ÿßÿ¨ÿ© ŸÑÿπŸÖŸÑ ÿ¥Ÿäÿ° ŸáŸÜÿß ŸÑÿ£ŸÜ ÿßŸÑŸÖŸÑŸÅ ŸáŸäÿ™ŸÖ ÿßÿÆÿ™Ÿäÿßÿ±Ÿá ÿØŸäŸÜÿßŸÖŸäŸÉŸäŸãÿß
        } else {
            if (ContextCompat.checkSelfPermission(this, Manifest.permission.WRITE_EXTERNAL_STORAGE)
                    != PackageManager.PERMISSION_GRANTED) {
                if (ActivityCompat.shouldShowRequestPermissionRationale(this, Manifest.permission.WRITE_EXTERNAL_STORAGE)) {
                    new AlertDialog.Builder(this)
                            .setTitle("Permission Needed")
                            .setMessage("This app needs storage permission to manage attendance files.")
                            .setPositiveButton("OK", (dialog, which) -> {
                                ActivityCompat.requestPermissions(this,
                                        new String[]{Manifest.permission.WRITE_EXTERNAL_STORAGE},
                                        STORAGE_PERMISSION_CODE);
                            })
                            .setNegativeButton("Cancel", null)
                            .show();
                } else {
                    ActivityCompat.requestPermissions(this,
                            new String[]{Manifest.permission.WRITE_EXTERNAL_STORAGE},
                            STORAGE_PERMISSION_CODE);
                }
            }
        }
    }

    // ŸÅŸä AdminActivity ÿØÿßÿÆŸÑ onGenerateBarcodeClick
    public void onGenerateBarcodeClick(View view) {
        executor.execute(() -> {
            try {
                List<Pair<String, String>> students = getAllStudents();
                if (students.isEmpty()) {
                    showErrorAsync("ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ£ÿ±ŸÇÿßŸÖ ÿ∑ŸÑÿßÿ® ŸÅŸä ŸÖŸÑŸÅ ÿßŸÑÿ•ŸÉÿ≥ŸÑ!");
                    return;
                }

                String sessionId = "SESSION_" + System.currentTimeMillis();
                long expiryTime = System.currentTimeMillis() + (2 * 60 * 60 * 1000); // 2 ÿ≥ÿßÿπÿ©

                List<String> studentIds = new ArrayList<>();
                for (Pair<String, String> student : students) {
                    studentIds.add(student.first.trim().toLowerCase());
                }
                Log.d(TAG, "Generating QR for session: " + sessionId + ", Students: " + studentIds);

                // ÿ≠ŸÅÿ∏ ÿßŸÑÿ¨ŸÑÿ≥ÿ© ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©
                dbHelper.addSession(sessionId, studentIds, expiryTime);

                // ÿ™ŸàŸÑŸäÿØ QR
                String qrContent = sessionId + "_" + String.join(",", studentIds);
                Log.d(TAG, "QR Content: " + qrContent);
                QRCodeWriter writer = new QRCodeWriter();
                BitMatrix bitMatrix = writer.encode(qrContent, BarcodeFormat.QR_CODE, 512, 512);
                Bitmap bitmap = toBitmap(bitMatrix);

                mainHandler.post(() -> {
                    qrCodeImageView.setImageBitmap(bitmap);
                    saveQRCodeToGallery(bitmap);
                    showSuccess("ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿ±ŸÖÿ≤ QR ŸÑŸÑÿ¨ŸÑÿ≥ÿ©: " + sessionId);
                });
            } catch (Exception e) {
                Log.e(TAG, "ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ŸÜÿ¥ÿßÿ° ÿ±ŸÖÿ≤ QR: " + e.getMessage());
                showErrorAsync("ŸÅÿ¥ŸÑ ŸÅŸä ÿ•ŸÜÿ¥ÿßÿ° ÿ±ŸÖÿ≤ QR: " + e.getMessage());
            }
        });
    }
    private List<Pair<String, String>> getAllStudents() {
        List<Pair<String, String>> students = new ArrayList<>();
        if (attendanceFileUri == null) {
            showErrorAsync("ŸÑŸÖ Ÿäÿ™ŸÖ ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÑŸÅ ÿ•ŸÉÿ≥ŸÑ!");
            return students;
        }
        try (InputStream fis = getContentResolver().openInputStream(attendanceFileUri);
             Workbook workbook = WorkbookFactory.create(fis)) {
            Sheet sheet = workbook.getSheetAt(0);
            for (Row row : sheet) {
                if (row.getRowNum() == 0) continue;
                Cell idCell = row.getCell(0);
                Cell nameCell = row.getCell(1);
                if (idCell != null && nameCell != null) {
                    String studentId = idCell.toString().trim();
                    String name = nameCell.toString().trim();
                    if (!studentId.isEmpty() && !name.isEmpty()) {
                        students.add(new Pair<>(studentId, name));
                    }
                }
            }
        } catch (Exception e) {
            Log.e(TAG, "Error reading students from Excel", e);
            showErrorAsync("ŸÅÿ¥ŸÑ ŸÅŸä ŸÇÿ±ÿßÿ°ÿ© ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ∑ŸÑÿßÿ®: " + e.getMessage());
        }
        return students;
    }

    private String generateSessionData() {
        return "ATTENDANCE-" + new SimpleDateFormat("yyyyMMdd-HHmmss", Locale.getDefault()).format(new Date());
    }

    private Bitmap toBitmap(BitMatrix matrix) {
        int width = matrix.getWidth();
        int height = matrix.getHeight();
        Bitmap bitmap = Bitmap.createBitmap(width, height, Bitmap.Config.ARGB_8888);

        for (int x = 0; x < width; x++) {
            for (int y = 0; y < height; y++) {
                bitmap.setPixel(x, y, matrix.get(x, y) ? Color.BLACK : Color.WHITE);
            }
        }

        return bitmap;
    }

    private void saveQRCodeToGallery(Bitmap bitmap) {
        String fileName = "QRCode_" + System.currentTimeMillis() + ".png";

        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.Q) {
            ContentValues values = new ContentValues(); // ÿ™ÿπÿ±ŸäŸÅ ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ± values ŸáŸÜÿß
            values.put(MediaStore.Images.Media.DISPLAY_NAME, fileName);
            values.put(MediaStore.Images.Media.MIME_TYPE, "image/png");
            values.put(MediaStore.Images.Media.RELATIVE_PATH, Environment.DIRECTORY_PICTURES);

            ContentResolver resolver = getContentResolver();
            Uri uri = resolver.insert(MediaStore.Images.Media.EXTERNAL_CONTENT_URI, values);

            if (uri != null) {
                try (OutputStream outputStream = resolver.openOutputStream(uri)) {
                    bitmap.compress(Bitmap.CompressFormat.PNG, 100, outputStream);
                    Toast.makeText(this, "ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿ±ŸÖÿ≤ QR ŸÅŸä ÿßŸÑŸÖÿπÿ±ÿ∂", Toast.LENGTH_SHORT).show();
                } catch (Exception e) {
                    Log.e(TAG, "ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿ±ŸÖÿ≤ QR: " + e.getMessage(), e);
                    Toast.makeText(this, "ŸÅÿ¥ŸÑ ŸÅŸä ÿ≠ŸÅÿ∏ ÿ±ŸÖÿ≤ QR: " + e.getMessage(), Toast.LENGTH_SHORT).show();
                }
            }
        } else {
            File imagesDir = Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_PICTURES);
            File image = new File(imagesDir, fileName);

            try (FileOutputStream fos = new FileOutputStream(image)) {
                bitmap.compress(Bitmap.CompressFormat.PNG, 100, fos);

                // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿµŸàÿ±ÿ© ÿ•ŸÑŸâ ŸÖÿπÿ±ÿ∂ ÿßŸÑÿµŸàÿ±
                Intent mediaScanIntent = new Intent(Intent.ACTION_MEDIA_SCANNER_SCAN_FILE);
                Uri contentUri = Uri.fromFile(image);
                mediaScanIntent.setData(contentUri);
                sendBroadcast(mediaScanIntent);

                Toast.makeText(this, "ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿ±ŸÖÿ≤ QR ŸÅŸä ÿßŸÑŸÖÿπÿ±ÿ∂", Toast.LENGTH_SHORT).show();
            } catch (Exception e) {
                Log.e(TAG, "ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿ±ŸÖÿ≤ QR: " + e.getMessage(), e);
                Toast.makeText(this, "ŸÅÿ¥ŸÑ ŸÅŸä ÿ≠ŸÅÿ∏ ÿ±ŸÖÿ≤ QR: " + e.getMessage(), Toast.LENGTH_SHORT).show();
            }
        }
    }
    public void onViewAttendanceClick(View view) {
        String sessionId = dbHelper.getLatestValidSessionId();
        if (sessionId == null) {
            Toast.makeText(this, "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ¨ŸÑÿ≥ÿ© ÿ≠ÿßŸÑŸäÿ© ÿµÿßŸÑÿ≠ÿ©!", Toast.LENGTH_SHORT).show();
            return;
        }

        Toast.makeText(this, "ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿ∂Ÿàÿ±...", Toast.LENGTH_SHORT).show();

        // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿ∂Ÿàÿ± ŸÖŸÜ Firebase
        DatabaseReference dbRef = FirebaseDatabase.getInstance()
                .getReference("attendance")
                .child(sessionId);

        dbRef.get().addOnSuccessListener(snapshot -> {
            if (snapshot.exists()) {
                // ÿ•ŸÜÿ¥ÿßÿ° ŸÇÿßÿ¶ŸÖÿ© ÿ®ÿ¨ŸÖŸäÿπ ÿßŸÑÿ∑ŸÑÿßÿ® (ÿßŸÑÿ≠ÿßÿ∂ÿ±ŸäŸÜ Ÿàÿ∫Ÿäÿ± ÿßŸÑÿ≠ÿßÿ∂ÿ±ŸäŸÜ)
                List<Pair<String, String>> allStudents = getAllStudents();
                Map<String, String> attendanceMap = new HashMap<>();

                // ÿ™ÿ≠ŸàŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ Firebase ÿ•ŸÑŸâ Map ŸÑŸÑÿ®ÿ≠ÿ´ ÿßŸÑÿ≥ÿ±Ÿäÿπ
                for (DataSnapshot child : snapshot.getChildren()) {
                    String studentId = child.getKey();
                    String status = child.getValue(String.class);
                    attendanceMap.put(studentId, status);
                }

                // ÿ®ŸÜÿßÿ° ŸÜÿµ ŸÑÿπÿ±ÿ∂ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿ∂Ÿàÿ±
                StringBuilder attendanceData = new StringBuilder();
                for (Pair<String, String> student : allStudents) {
                    String studentId = student.first;
                    String studentName = student.second;

                    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ≠ÿ∂Ÿàÿ±
                    String status = attendanceMap.get(studentId);
                    String attendanceStatus;
                    String attendanceTime = "";

                    if (status != null && status.contains("Present")) {
                        attendanceStatus = "Present";

                        // ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ŸàŸÇÿ™ ÿßŸÑÿ≠ÿ∂Ÿàÿ± ŸÖŸÜ ÿßŸÑŸÜÿµ
                        if (status.contains(" - ")) {
                            String[] parts = status.split(" - ");
                            if (parts.length >= 3) {
                                attendanceTime = parts[2];
                            }
                        }
                    } else {
                        attendanceStatus = "Absent";
                    }

                    // ÿ®ŸÜÿßÿ° ÿ≥ÿ∑ÿ± ŸÑŸÉŸÑ ÿ∑ÿßŸÑÿ®
                    attendanceData.append(studentId)
                            .append(" - ")
                            .append(studentName)
                            .append(": ")
                            .append(attendanceStatus);

                    // ÿ•ÿ∂ÿßŸÅÿ© ŸàŸÇÿ™ ÿßŸÑÿ≠ÿ∂Ÿàÿ± ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÖÿ™ÿßÿ≠Ÿãÿß
                    if (!attendanceTime.isEmpty()) {
                        attendanceData.append(" (").append(attendanceTime).append(")");
                    }

                    attendanceData.append("\n\n");
                }

                // ÿπÿ±ÿ∂ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿ∂Ÿàÿ±
                Intent intent = new Intent(this, DisplayActivity.class);
                intent.putExtra("excel_data", attendanceData.toString());
                startActivity(intent);
            } else {
                Toast.makeText(this, "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ÿ≠ÿ∂Ÿàÿ± ŸÑŸÑÿ¨ŸÑÿ≥ÿ© ÿßŸÑŸÖÿ≠ÿØÿØÿ©", Toast.LENGTH_LONG).show();
            }
        }).addOnFailureListener(e -> {
            Log.e(TAG, "ŸÅÿ¥ŸÑ ŸÅŸä ÿ¨ŸÑÿ® ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿ∂Ÿàÿ± ŸÖŸÜ Firebase: " + e.getMessage(), e);
            Toast.makeText(this, "ŸÅÿ¥ŸÑ ŸÅŸä ÿ¨ŸÑÿ® ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿ∂Ÿàÿ±: " + e.getMessage(), Toast.LENGTH_LONG).show();
        });
    }

    public void onViewStudentListClick(View view) {
        // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ∑ŸÑÿßÿ® ŸÖŸÜ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©
        List<Pair<String, String>> students = getAllStudents();

        if (students.isEmpty()) {
            Toast.makeText(this, "No students registered!", Toast.LENGTH_SHORT).show();
            return;
        }

        // ÿ®ŸÜÿßÿ° ŸÜÿµ ŸÑÿπÿ±ÿ∂ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ∑ŸÑÿßÿ® (ÿßŸÑÿ±ŸÇŸÖ ŸàÿßŸÑÿßÿ≥ŸÖ ŸÅŸÇÿ∑)
        StringBuilder studentList = new StringBuilder();
        studentList.append("Student List:\n\n");

        for (Pair<String, String> student : students) {
            studentList.append("ID: ").append(student.first)
                    .append("\nName: ").append(student.second)
                    .append("\n\n");
        }

        // ÿπÿ±ÿ∂ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ∑ŸÑÿßÿ®
        Intent intent = new Intent(this, DisplayActivity.class);
        intent.putExtra("excel_data", studentList.toString());
        intent.putExtra("title", "Student List");
        startActivity(intent);
    }


    public void onUploadExcelClick (View view){
            Log.d(TAG, "Upload Excel clicked");
            Intent intent = new Intent(Intent.ACTION_OPEN_DOCUMENT);
            intent.addCategory(Intent.CATEGORY_OPENABLE);
            intent.setType("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
            pickFileLauncher.launch(intent);
        }


        public void copyExcelFile (Uri uri){
            executor.execute(() -> {
                try (InputStream inputStream = getContentResolver().openInputStream(uri)) {
                    Workbook workbook = WorkbookFactory.create(inputStream);
                    Sheet sheet = workbook.getSheetAt(0);
                    SQLiteDatabase db = dbHelper.getWritableDatabase();
                    db.execSQL("DELETE FROM students");
                    Log.d(TAG, "ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÇÿØŸäŸÖÿ© ŸÖŸÜ ÿ¨ÿØŸàŸÑ students");

                    DataFormatter dataFormatter = new DataFormatter();
                    HashSet<String> existingIds = new HashSet<>();

                    for (Row row : sheet) {
                        if (row.getRowNum() == 0) continue;

                        Cell idCell = row.getCell(0, Row.MissingCellPolicy.CREATE_NULL_AS_BLANK);
                        String studentId = getCellValue(idCell, dataFormatter);
                        if (idCell.getCellType() == CellType.NUMERIC) {
                            studentId = String.valueOf((long) idCell.getNumericCellValue());
                        }

                        if (studentId.trim().isEmpty() || existingIds.contains(studentId)) {
                            Log.w(TAG, "Skipping duplicate or empty student ID: " + studentId);
                            continue;
                        }

                        Cell nameCell = row.getCell(1, Row.MissingCellPolicy.CREATE_NULL_AS_BLANK);
                        String studentName = getCellValue(nameCell, dataFormatter);
                        if (studentName.trim().isEmpty()) {
                            studentName = "Unknown Student";
                        }

                        dbHelper.addStudent(studentId, studentName);
                        existingIds.add(studentId);
                        Log.d(TAG, "Added student: " + studentId + " with name: " + studentName);
                    }
                    db.close();
                    workbook.close();
                    mainHandler.post(() -> Toast.makeText(this, "ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖŸÑŸÅ ÿ®ŸÜÿ¨ÿßÿ≠", Toast.LENGTH_SHORT).show());
                } catch (Exception e) {
                    Log.e(TAG, "Error copying Excel file: " + e.getMessage(), e);
                    showErrorAsync("ÿÆÿ∑ÿ£ ŸÅŸä ŸÜÿ≥ÿÆ ÿßŸÑŸÖŸÑŸÅ: " + e.getMessage());
                }
            });
        }
        // ÿØÿßŸÑÿ© ŸÖÿ≥ÿßÿπÿØÿ© ŸÑŸÇÿ±ÿßÿ°ÿ© ŸÇŸäŸÖÿ© ÿßŸÑÿÆŸÑŸäÿ© ÿ®ŸÉŸÑ ÿßŸÑÿ∑ÿ±ŸÇ ÿßŸÑŸÖŸÖŸÉŸÜÿ©
        private String getCellValue (Cell cell, DataFormatter formatter){
            if (cell == null) return "";
            switch (cell.getCellType()) {
                case STRING:
                    return cell.getStringCellValue().trim();
                case NUMERIC:
                    return formatter.formatCellValue(cell).trim();
                case BLANK:
                    return "";
                default:
                    return formatter.formatCellValue(cell).trim();
            }
        }
        private void importStudentsFromExcel (File file){
            executor.execute(() -> {
                try (FileInputStream fis = new FileInputStream(file);
                     Workbook workbook = WorkbookFactory.create(fis)) {
                    Sheet sheet = workbook.getSheetAt(0);
                    for (Row row : sheet) {
                        if (row.getRowNum() == 0) continue;
                        Cell idCell = row.getCell(0);
                        Cell nameCell = row.getCell(1);
                        if (idCell != null && nameCell != null) {
                            String studentId = idCell.toString().trim();
                            String name = nameCell.toString().trim();
                            dbHelper.addStudent(studentId, name);
                        }
                    }
                    Log.d(TAG, "All students imported into database.");
                } catch (Exception e) {
                    Log.e(TAG, "Error importing students", e);
                }
            });
        }

        private boolean isValidHeader (Row headerRow){
            if (headerRow == null) {
                Log.e(TAG, "Header row is null");
                return false;
            }
            String[] expectedHeaders = {"Student ID", "Name", "Attendance"};
            for (int i = 0; i < expectedHeaders.length; i++) {
                Cell cell = headerRow.getCell(i, Row.MissingCellPolicy.CREATE_NULL_AS_BLANK);
                String cellValue = cell.getStringCellValue().trim()
                        .replaceAll("[^a-zA-Z0-9]", "")
                        .toLowerCase();
                String expected = expectedHeaders[i].replaceAll("[^a-zA-Z0-9]", "").toLowerCase();
                Log.d(TAG, "Header Check - Expected: " + expected + " | Found: " + cellValue);
                if (!expected.equals(cellValue)) {
                    Log.e(TAG, "Header mismatch at column " + i);
                    return false;
                }
            }
            return true;
        }

        private void readExcelAndDisplay ( boolean showAttendance){
            if (attendanceFileUri == null) {
                showErrorAsync("ŸÑŸÖ Ÿäÿ™ŸÖ ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÑŸÅ ÿ•ŸÉÿ≥ŸÑ!");
                return;
            }
            executor.execute(() -> {
                try (InputStream fis = getContentResolver().openInputStream(attendanceFileUri);
                     Workbook workbook = WorkbookFactory.create(fis)) {
                    Log.d(TAG, "Reading Excel file...");
                    Sheet sheet = workbook.getSheetAt(0);
                    if (sheet == null) {
                        showErrorAsync("ÿßŸÑŸàÿ±ŸÇÿ© ŸÅÿßÿ±ÿ∫ÿ©!");
                        return;
                    }
                    StringBuilder result = new StringBuilder();
                    HashMap<String, String> attendanceMap = new HashMap<>();
                    for (Row row : sheet) {
                        if (row.getRowNum() == 0) continue;
                        Cell idCell = row.getCell(0, Row.MissingCellPolicy.CREATE_NULL_AS_BLANK);
                        Cell nameCell = row.getCell(1, Row.MissingCellPolicy.CREATE_NULL_AS_BLANK);
                        Cell attendanceCell = row.getCell(2, Row.MissingCellPolicy.CREATE_NULL_AS_BLANK);
                        String studentId = idCell.toString().trim();
                        if (studentId.isEmpty()) continue;
                        Cursor cursor = dbHelper.getReadableDatabase().rawQuery(
                                "SELECT name, attendance FROM students WHERE student_id = ?",
                                new String[]{studentId.trim().toLowerCase()});
                        String studentName = "Unknown Student";
                        String attendanceStatus = "Absent";
                        if (cursor.moveToFirst()) {
                            studentName = cursor.getString(0);
                            int attendance = cursor.getInt(1);
                            attendanceStatus = attendance == 1 ? "Present" : "Absent";
                        }
                        cursor.close();
                        nameCell.setCellValue(studentName);
                        attendanceCell.setCellValue(attendanceStatus);
                        attendanceMap.put(studentId, studentName + ": " + attendanceStatus);
                    }
                    try (OutputStream fos = getContentResolver().openOutputStream(attendanceFileUri)) {
                        workbook.write(fos);
                        Log.d(TAG, "Excel file updated successfully!");
                    }
                    for (Map.Entry<String, String> entry : attendanceMap.entrySet()) {
                        result.append(entry.getKey()).append(" - ").append(entry.getValue()).append("\n\n");
                    }
                    if (result.length() == 0) {
                        showErrorAsync("ŸÑÿß ŸäŸàÿ¨ÿØ ÿ∑ŸÑÿßÿ®!");
                        return;
                    }
                    mainHandler.post(() -> {
                        Intent intent = new Intent(AdminActivity.this, DisplayActivity.class);
                        intent.putExtra("excel_data", result.toString());
                        startActivity(intent);
                    });
                } catch (Exception e) {
                    Log.e(TAG, "ÿÆÿ∑ÿ£ ŸÅŸä ŸÇÿ±ÿßÿ°ÿ© ÿ£Ÿà ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ•ŸÉÿ≥ŸÑ", e);
                    showErrorAsync("ÿÆÿ∑ÿ£: " + e.getMessage());
                }
            });
        }

        private String getCellStringValue (Cell cell){
            if (cell == null) return "N/A";
            try {
                switch (cell.getCellType()) {
                    case STRING:
                        return cell.getStringCellValue().trim();
                    case NUMERIC:
                        if (DateUtil.isCellDateFormatted(cell)) {
                            return new SimpleDateFormat("yyyy-MM-dd", Locale.getDefault())
                                    .format(cell.getDateCellValue());
                        }
                        return String.valueOf((int) cell.getNumericCellValue());
                    case BOOLEAN:
                        return String.valueOf(cell.getBooleanCellValue());
                    case FORMULA:
                        return cell.getCellFormula();
                    default:
                        return "N/A";
                }
            } catch (Exception e) {
                Log.e(TAG, "Error reading cell", e);
                return "N/A";
            }
        }

        private void showSuccessAsync (String message){
            mainHandler.post(() -> showSuccess(message));
        }

        private void showErrorAsync (String message){
            mainHandler.post(() -> {
                Log.e(TAG, message);
                showError(message);
            });
        }

        private void showSuccess (String message){
            Toast.makeText(this, message, Toast.LENGTH_LONG).show();
        }

        private void showError (String message){
            Toast.makeText(this, message, Toast.LENGTH_LONG).show();
        }

        @Override
        public boolean onOptionsItemSelected (MenuItem item){
            if (item.getItemId() == android.R.id.home) {
                finish();
                return true;
            }
            return super.onOptionsItemSelected(item);
        }

        @Override
        public void onRequestPermissionsResult ( int requestCode, @NonNull String[] permissions,
        @NonNull int[] grantResults){
            super.onRequestPermissionsResult(requestCode, permissions, grantResults);
            if (requestCode == STORAGE_PERMISSION_CODE) {
                if (grantResults.length > 0 && grantResults[0] == PackageManager.PERMISSION_GRANTED) {
                    Toast.makeText(this, "Storage permission granted", Toast.LENGTH_SHORT).show();
                } else {
                    Toast.makeText(this, "Storage permission denied", Toast.LENGTH_SHORT).show();
                }
            }
        }


        // ÿ£ÿ∂ŸÅ Ÿáÿ∞Ÿá ÿßŸÑÿØÿßŸÑÿ© ŸÅŸä onCreate
        private void setupFirebaseListener () {
            // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸáŸÜÿßŸÉ ÿ¨ŸÑÿ≥ÿ© ŸÜÿ¥ÿ∑ÿ©ÿå ŸÇŸÖ ÿ®ÿ•ÿπÿØÿßÿØ ÿßŸÑŸÖÿ±ÿßŸÇÿ®
            SQLiteDatabase db = dbHelper.getReadableDatabase();
            Cursor cursor = db.rawQuery(
                    "SELECT session_id FROM sessions WHERE expiry_time > ? ORDER BY expiry_time DESC LIMIT 1",
                    new String[]{String.valueOf(System.currentTimeMillis())}
            );

            if (cursor.moveToFirst()) {
                String activeSessionId = cursor.getString(0);
                cursor.close();
                db.close();

                Log.d(TAG, "Setting up Firebase listener for session: " + activeSessionId);

                com.google.firebase.database.DatabaseReference dbRef =
                        com.google.firebase.database.FirebaseDatabase.getInstance()
                                .getReference("attendance")
                                .child(activeSessionId);

                attendanceListener = new com.google.firebase.database.ValueEventListener() {
                    @Override
                    public void onDataChange(@NonNull com.google.firebase.database.DataSnapshot snapshot) {
                        Log.d(TAG, "Firebase data changed for session: " + activeSessionId);
                        // ÿ™ÿ≠ÿØŸäÿ´ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ© ŸÖŸÜ Firebase
                        for (com.google.firebase.database.DataSnapshot childSnapshot : snapshot.getChildren()) {
                            String studentId = childSnapshot.getKey();
                            String attendanceValue = childSnapshot.getValue(String.class);

                            if (studentId != null && attendanceValue != null && attendanceValue.contains("Present")) {
                                Log.d(TAG, "Student marked present in Firebase: " + studentId);
                                // ÿ™ÿ≠ÿØŸäÿ´ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©
                                SQLiteDatabase localDb = dbHelper.getWritableDatabase();
                                ContentValues values = new ContentValues();
                                values.put("attendance", 1);
                                localDb.update("students", values, "student_id = ?", new String[]{studentId.trim().toLowerCase()});
                                localDb.close();
                            }
                        }

                    }

                    @Override
                    public void onCancelled(@NonNull com.google.firebase.database.DatabaseError error) {
                        Log.e(TAG, "Firebase listener cancelled: " + error.getMessage());
                    }
                };

                dbRef.addValueEventListener(attendanceListener);
            } else {
                cursor.close();
                db.close();
                Log.d(TAG, "No active session found for Firebase listener");
            }
        }

        // ÿ£ÿ∂ŸÅ Ÿáÿ∞Ÿá ÿßŸÑÿØÿßŸÑÿ© ŸÅŸä onDestroy
        @Override
        protected void onDestroy () {
            super.onDestroy();
            // ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑŸÖÿ±ÿßŸÇÿ® ÿπŸÜÿØ ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÜÿ¥ÿßÿ∑
            if (attendanceListener != null) {
                com.google.firebase.database.FirebaseDatabase.getInstance()
                        .getReference("attendance")
                        .removeEventListener(attendanceListener);
            }
        }
    private void generateExcelFromFirebase(String sessionId) {
        executor.execute(() -> {
            try {
                // ÿ•ŸÜÿ¥ÿßÿ° ŸÖÿµŸÜŸÅ Excel ÿ¨ÿØŸäÿØ
                Workbook workbook = new XSSFWorkbook();
                Sheet sheet = workbook.createSheet("Attendance");

                // ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿµŸÅ ÿßŸÑÿ£ŸàŸÑ (ÿßŸÑÿπŸÜÿßŸàŸäŸÜ)
                Row headerRow = sheet.createRow(0);
                Cell idHeaderCell = headerRow.createCell(0);
                idHeaderCell.setCellValue("Student ID");
                Cell nameHeaderCell = headerRow.createCell(1);
                nameHeaderCell.setCellValue("Student Name");
                Cell attendanceHeaderCell = headerRow.createCell(2);
                attendanceHeaderCell.setCellValue("Attendance Status");
                Cell timeHeaderCell = headerRow.createCell(3);
                timeHeaderCell.setCellValue("Attendance Time");

                // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿ∂Ÿàÿ± ŸÖŸÜ Firebase
                DatabaseReference dbRef = FirebaseDatabase.getInstance()
                        .getReference("attendance")
                        .child(sessionId);

                dbRef.get().addOnSuccessListener(snapshot -> {
                    if (snapshot.exists()) {
                        Log.d(TAG, "ÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿ∂Ÿàÿ± ŸÅŸä Firebase: " + snapshot.getChildrenCount() + " ÿ∑ÿßŸÑÿ®");

                        // ÿ•ŸÜÿ¥ÿßÿ° ŸÇÿßÿ¶ŸÖÿ© ÿ®ÿ¨ŸÖŸäÿπ ÿßŸÑÿ∑ŸÑÿßÿ® (ÿßŸÑÿ≠ÿßÿ∂ÿ±ŸäŸÜ Ÿàÿ∫Ÿäÿ± ÿßŸÑÿ≠ÿßÿ∂ÿ±ŸäŸÜ)
                        List<Pair<String, String>> allStudents = getAllStudents();
                        Map<String, String> attendanceMap = new HashMap<>();

                        // ÿ™ÿ≠ŸàŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ Firebase ÿ•ŸÑŸâ Map ŸÑŸÑÿ®ÿ≠ÿ´ ÿßŸÑÿ≥ÿ±Ÿäÿπ
                        for (DataSnapshot child : snapshot.getChildren()) {
                            String studentId = child.getKey();
                            String status = child.getValue(String.class);
                            attendanceMap.put(studentId, status);
                        }

                        // ÿ•ÿ∂ÿßŸÅÿ© ÿ¨ŸÖŸäÿπ ÿßŸÑÿ∑ŸÑÿßÿ® ÿ•ŸÑŸâ ŸÖŸÑŸÅ Excel
                        int rowNum = 1;
                        for (Pair<String, String> student : allStudents) {
                            String studentId = student.first;
                            String studentName = student.second;

                            Row row = sheet.createRow(rowNum++);
                            row.createCell(0).setCellValue(studentId);
                            row.createCell(1).setCellValue(studentName);

                            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ≠ÿ∂Ÿàÿ±
                            String status = attendanceMap.get(studentId);
                            if (status != null && status.contains("Present")) {
                                row.createCell(2).setCellValue("Present");

                                // ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ŸàŸÇÿ™ ÿßŸÑÿ≠ÿ∂Ÿàÿ± ŸÖŸÜ ÿßŸÑŸÜÿµ - ŸáŸÜÿß ÿßŸÑÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®
                                String attendanceTime = "";
                                if (status.contains(" - ")) {
                                    // ÿ™ŸÇÿ≥ŸäŸÖ ÿßŸÑŸÜÿµ ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ " - "
                                    String[] parts = status.split(" - ");
                                    // ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ£ÿÆŸäÿ± Ÿäÿ≠ÿ™ŸàŸä ÿπŸÑŸâ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸàÿßŸÑŸàŸÇÿ™ (ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÖŸàÿ¨ŸàÿØŸãÿß)
                                    if (parts.length >= 3) {
                                        attendanceTime = parts[parts.length - 1]; // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿ¢ÿÆÿ± ÿ¨ÿ≤ÿ° ÿØÿßÿ¶ŸÖŸãÿß
                                        Log.d(TAG, "ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿßŸÑŸàŸÇÿ™: " + attendanceTime + " ŸÖŸÜ ÿßŸÑŸÜÿµ: " + status);
                                    }
                                }
                                row.createCell(3).setCellValue(attendanceTime);
                            } else {
                                // ÿ•ÿ∂ÿßŸÅÿ© ÿßÿ≥ŸÖ ÿßŸÑÿ∑ÿßŸÑÿ® ŸÑŸÑÿ∫ÿßÿ¶ÿ®ŸäŸÜ ÿ£Ÿäÿ∂Ÿãÿß
                                row.createCell(2).setCellValue("Absent");
                                row.createCell(3).setCellValue("");

                                // ÿ™ÿ≠ÿØŸäÿ´ Firebase ÿ®ÿ£ÿ≥ŸÖÿßÿ° ÿßŸÑÿ∑ŸÑÿßÿ® ÿßŸÑÿ∫ÿßÿ¶ÿ®ŸäŸÜ
                                if (status == null || status.equals("Not Yet Attended")) {
                                    dbRef.child(studentId).setValue("Not Yet Attended - " + studentName);
                                }
                            }
                        }

                        // ÿ≠ŸÅÿ∏ ŸÖŸÑŸÅ Excel
                        saveExcelFile(workbook, sessionId);
                    } else {
                        mainHandler.post(() -> {
                            Toast.makeText(AdminActivity.this, "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ÿ≠ÿ∂Ÿàÿ± ŸÑŸÑÿ¨ŸÑÿ≥ÿ© ÿßŸÑŸÖÿ≠ÿØÿØÿ©", Toast.LENGTH_LONG).show();
                        });
                    }
                }).addOnFailureListener(e -> {
                    Log.e(TAG, "ŸÅÿ¥ŸÑ ŸÅŸä ÿ¨ŸÑÿ® ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿ∂Ÿàÿ± ŸÖŸÜ Firebase: " + e.getMessage(), e);
                    mainHandler.post(() -> {
                        Toast.makeText(AdminActivity.this, "ŸÅÿ¥ŸÑ ŸÅŸä ÿ¨ŸÑÿ® ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿ∂Ÿàÿ±: " + e.getMessage(), Toast.LENGTH_LONG).show();
                    });
                });
            } catch (Exception e) {
                Log.e(TAG, "ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ŸÜÿ¥ÿßÿ° ŸÖŸÑŸÅ Excel: " + e.getMessage(), e);
                mainHandler.post(() -> {
                    Toast.makeText(AdminActivity.this, "ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ŸÜÿ¥ÿßÿ° ŸÖŸÑŸÅ Excel: " + e.getMessage(), Toast.LENGTH_LONG).show();
                });
            }
        });
    }


        private void saveExcelFile (Workbook workbook, String sessionId){
            try {
                // ÿ•ŸÜÿ¥ÿßÿ° ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÑŸÅ
                String fileName = "Attendance_" + sessionId + ".xlsx";

                if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.Q) {
                    // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ MediaStore ŸÑÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÑŸÅ ŸÅŸä Android 10 ŸàŸÖÿß ŸÅŸàŸÇ
                    ContentValues values = new ContentValues();
                    values.put(MediaStore.MediaColumns.DISPLAY_NAME, fileName);
                    values.put(MediaStore.MediaColumns.MIME_TYPE, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
                    values.put(MediaStore.MediaColumns.RELATIVE_PATH, Environment.DIRECTORY_DOCUMENTS);

                    ContentResolver resolver = getContentResolver();
                    Uri uri = resolver.insert(MediaStore.Files.getContentUri("external"), values);

                    if (uri != null) {
                        try (OutputStream outputStream = resolver.openOutputStream(uri)) {
                            workbook.write(outputStream);

                            // ÿ≠ŸÅÿ∏ URI ŸÅŸä SharedPreferences
                            SharedPreferences prefs = getSharedPreferences("AppPrefs", MODE_PRIVATE);
                            SharedPreferences.Editor editor = prefs.edit();
                            editor.putString("attendance_file_uri", uri.toString());
                            editor.apply();

                            attendanceFileUri = uri;

                            mainHandler.post(() -> {
                                Toast.makeText(AdminActivity.this, "ÿ™ŸÖ ÿ≠ŸÅÿ∏ ŸÖŸÑŸÅ Excel ÿ®ŸÜÿ¨ÿßÿ≠: " + fileName, Toast.LENGTH_LONG).show();

                                // ÿπÿ±ÿ∂ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ÿπÿØ ÿßŸÑÿ≠ŸÅÿ∏
                                Intent intent = new Intent(AdminActivity.this, DisplayActivity.class);
                                intent.putExtra("attendance_file_uri", uri.toString());
                                startActivity(intent);
                            });
                        }
                    } else {
                        throw new IOException("ŸÅÿ¥ŸÑ ŸÅŸä ÿ•ŸÜÿ¥ÿßÿ° URI ŸÑŸÑŸÖŸÑŸÅ");
                    }
                } else {
                    // ŸÑÿ•ÿµÿØÿßÿ±ÿßÿ™ Android ÿßŸÑÿ£ŸÇÿØŸÖ
                    File documentsDir = Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DOCUMENTS);
                    if (!documentsDir.exists()) {
                        documentsDir.mkdirs();
                    }

                    File file = new File(documentsDir, fileName);
                    try (FileOutputStream fos = new FileOutputStream(file)) {
                        workbook.write(fos);

                        // ÿ≠ŸÅÿ∏ ŸÖÿ≥ÿßÿ± ÿßŸÑŸÖŸÑŸÅ ŸÅŸä SharedPreferences
                        SharedPreferences prefs = getSharedPreferences("AppPrefs", MODE_PRIVATE);
                        SharedPreferences.Editor editor = prefs.edit();
                        editor.putString("attendance_file_uri", Uri.fromFile(file).toString());
                        editor.apply();

                        attendanceFileUri = Uri.fromFile(file);

                        mainHandler.post(() -> {
                            Toast.makeText(AdminActivity.this, "ÿ™ŸÖ ÿ≠ŸÅÿ∏ ŸÖŸÑŸÅ Excel ÿ®ŸÜÿ¨ÿßÿ≠: " + file.getAbsolutePath(), Toast.LENGTH_LONG).show();

                            // ÿπÿ±ÿ∂ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ÿπÿØ ÿßŸÑÿ≠ŸÅÿ∏
                            Intent intent = new Intent(AdminActivity.this, DisplayActivity.class);
                            intent.putExtra("attendance_file_uri", Uri.fromFile(file).toString());
                            startActivity(intent);
                        });
                    }
                }
            } catch (Exception e) {
                Log.e(TAG, "ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ŸÖŸÑŸÅ Excel: " + e.getMessage(), e);
                mainHandler.post(() -> {
                    Toast.makeText(AdminActivity.this, "ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ŸÖŸÑŸÅ Excel: " + e.getMessage(), Toast.LENGTH_LONG).show();
                });
            }
        }

}
